#!/usr/bin/env bash

function connect_to_tailnet() {
  tailscale up \
    --authkey="${TAILSCALE_AUTH_KEY}" \
    --hostname="$TAILSCALE_HOSTNAME" \
    --advertise-tags=${TAILSCALE_ADVERTISE_TAGS:-} \
    ${TAILSCALE_ADDITIONAL_ARGS:---accept-routes --timeout=15s} > /dev/null 2>&1

  if ! tailnet_is_running; then
    log_tailscale_info "Connected to tailnet as hostname=$TAILSCALE_HOSTNAME; SOCKS5 proxy available at localhost:1055"
  else
    log_tailscale_warn "did not reach 'Running' state within timeout"
    exit 1
  fi
}

function expose_heroku_port_to_tailnet() {
  if dyno_type_is "run"; then
    log_tailscale_info "skipping 'tailscale serve --bg $PORT' on run dyno"
  else
    # expose the Heroku dyno port to the tailnet
    tailscale serve --bg $PORT
  fi
}

function tailnet_is_running() {
  timeout=${TAILSCALE_RUNNING_TIMEOUT:-10} # Timeout in seconds
  interval=0.5  # Interval between checks

  # convert to milliseconds so we can use integer math
  timeout_ms=$(awk "BEGIN {print $timeout * 1000}")
  interval_ms=$(awk "BEGIN {print $interval * 1000}")

  elapsed=0

  while [ "$elapsed" -lt "$timeout_ms" ]; do
    if tailscale_backend_state_running; then
      return 0
    fi
    echo "."
    sleep "$interval"

    elapsed=$((elapsed + interval_ms))
  done

  return 1
}
